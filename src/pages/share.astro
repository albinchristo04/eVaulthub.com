---
import BaseLayout from '../layouts/BaseLayout.astro';
import AdUnit from '../components/AdUnit.astro';

const title = 'Generador de Enlaces para Telegram | dx.evaulthub.com';
const description = 'Herramienta para generar y copiar la programaci√≥n deportiva para compartir en Telegram.';

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": title,
  "description": description
};
---

<BaseLayout title={title} description={description} jsonLd={jsonLd}>
  <div class="ad-top">
    <AdUnit type="728x90" />
  </div>

  <section class="tool-section">
    <h1 class="section-title">üì§ Generador de Enlaces Telegram</h1>
    
    <AdUnit type="320x50" className="mb-lg" />

    <div class="tool-controls">
      <button id="copyAllBtn" class="copy-btn">üìã Copiar Todo el Calendario</button>
      <button id="shareTelegramBtn" class="share-btn telegram">‚úàÔ∏è Compartir en Telegram</button>
    </div>

    <div id="shareContainer" class="share-tool-container">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Cargando eventos de ambos servidores...</p>
      </div>
    </div>
    
    <AdUnit type="300x100" />

    <div class="preview-section">
      <h3>Vista Previa del Texto</h3>
      <textarea id="fullPreview" class="embed-code" readonly placeholder="El texto generado aparecer√° aqu√≠..."></textarea>
    </div>

    <AdUnit type="250x250" className="mt-lg" />
  </section>
</BaseLayout>

<style>
  .tool-section {
    max-width: 800px;
    margin: 0 auto;
  }
  .tool-controls {
    display: flex;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }
  .share-tool-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: var(--border-radius);
    padding: var(--space-md);
    margin-bottom: var(--space-lg);
    max-height: 500px;
    overflow-y: auto;
  }
  .share-item {
    background: #1a1a1a;
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--border-radius-sm);
    margin-bottom: var(--space-sm);
    border-left: 4px solid var(--color-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .share-item-info {
    flex: 1;
  }
  .share-item-title {
    font-weight: 600;
    font-size: var(--font-size-sm);
  }
  .share-item-time {
    font-size: var(--font-size-xs);
    color: var(--color-primary-light);
  }
  .preview-section {
    margin-top: var(--space-xl);
  }
  .preview-section h3 {
    margin-bottom: var(--space-md);
  }
  #fullPreview {
    height: 400px;
  }
</style>

<script is:inline>
  const SERVER1_URL = 'https://raw.githubusercontent.com/albinchristo04/blogger-autopost/refs/heads/main/rojadirecta_events.json';
  const SERVER2_URL = 'https://raw.githubusercontent.com/albinchristo04/ptv/refs/heads/main/events.json';
  
  function slugify(text) {
    return text.toString().toLowerCase().normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-+/, '').replace(/-+$/, '').substring(0, 100);
  }
  
  function parseDescription(desc) {
    const parts = desc.split(':');
    const competition = parts[0]?.trim() || 'Deportes';
    const matchTitle = parts.slice(1).join(':').trim().replace(/\n/g, ' ') || desc.trim();
    return { competition, matchTitle };
  }

  function formatForTelegram(matches) {
    let text = "üöÄ *PROGRAMACI√ìN DE HOY EN VIVO* üöÄ\n\n";
    
    // Group by date
    const groups = {};
    matches.forEach(m => {
      if (!groups[m.date]) groups[m.date] = [];
      groups[m.date].push(m);
    });

    const sortedDates = Object.keys(groups).sort((a,b) => a.localeCompare(b));

    sortedDates.forEach(date => {
      text += `üìÖ *${date}*\n`;
      groups[date].forEach(m => {
        text += `‚öΩ ${m.match_title}\n`;
        text += `‚è∞ ${m.time} | ${m.competition}\n`;
        text += `üîó https://dx.evaulthub.com/partido/${m.slug}/\n\n`;
      });
    });
    
    text += "üì∫ *MIRA TODOS AQU√ç* üëá\nhttps://dx.evaulthub.com/";
    return text;
  }

  async function init() {
    const container = document.getElementById('shareContainer');
    const preview = document.getElementById('fullPreview');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const shareTelegramBtn = document.getElementById('shareTelegramBtn');

    const allNormalizedMatches = [];
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(23, 59, 59, 999);

    try {
      // Fetch Server 1
      try {
        const r1 = await fetch(SERVER1_URL);
        const data1 = await r1.json();
        const events1 = data1.events || data1 || [];
        events1.forEach(e => {
          const { competition, matchTitle } = parseDescription(e.description || '');
          allNormalizedMatches.push({
            match_title: matchTitle,
            competition,
            date: e.date,
            time: e.time?.substring(0,5) || '00:00',
            slug: slugify(`${competition}-${matchTitle}`)
          });
        });
      } catch (e) { console.error('Server 1 fail', e); }

      // Fetch Server 2
      try {
        const r2 = await fetch(SERVER2_URL);
        const data2 = await r2.json();
        const streams2 = data2.events?.streams || [];
        streams2.forEach(cat => {
          if (cat.category === '24/7 Streams') return;
          cat.streams?.forEach(s => {
            const startsAt = s.starts_at * 1000;
            const endsAt = s.ends_at * 1000;
            const matchDate = new Date(startsAt);
            const matchEndDate = new Date(endsAt);
            
            if (matchDate > tomorrow) return;
            if (endsAt > 0) { if (matchEndDate < now) return; }
            else { if (new Date(startsAt + (3 * 60 * 60 * 1000)) < now) return; }

            const competition = s.category_name || cat.category || 'Deportes';
            const matchTitle = s.name;
            allNormalizedMatches.push({
              match_title: matchTitle,
              competition,
              date: matchDate.toISOString().split('T')[0],
              time: matchDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false }),
              slug: slugify(`${competition}-${matchTitle}`)
            });
          });
        });
      } catch (e) { console.error('Server 2 fail', e); }

      // De-duplicate
      const unique = [];
      const seen = new Set();
      allNormalizedMatches.forEach(m => {
        if (!seen.has(m.slug)) {
          seen.add(m.slug);
          unique.push(m);
        }
      });

      if (!unique.length) {
        container.innerHTML = '<p>No hay eventos disponibles.</p>';
        return;
      }

      // Sort by date and time
      unique.sort((a,b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
      });

      const formattedText = formatForTelegram(unique);
      preview.value = formattedText;

      let html = '';
      unique.forEach(m => {
        html += `
          <div class="share-item">
            <div class="share-item-info">
              <div class="share-item-title">${m.match_title}</div>
              <div class="share-item-time">${m.time} - ${m.date} | ${m.competition}</div>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;

      copyAllBtn.addEventListener('click', () => {
        preview.select();
        document.execCommand('copy');
        copyAllBtn.textContent = '‚úÖ ¬°Copiado!';
        setTimeout(() => copyAllBtn.textContent = 'üìã Copiar Todo el Calendario', 2000);
      });

      shareTelegramBtn.addEventListener('click', () => {
        const telegramUrl = `https://t.me/share/url?url=https://dx.evaulthub.com/&text=${encodeURIComponent(formattedText)}`;
        window.open(telegramUrl, '_blank');
      });

    } catch (e) {
      container.innerHTML = '<p>Error al cargar los datos.</p>';
    }
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
